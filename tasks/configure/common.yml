---
# Configuration tasks common to all distros

- block:
    - name: ensure docker group is present
      group:
        name: docker
        state: present
        system: yes

    - name: add users into docker group
      user:
        append: yes
        groups: docker
        state: present
        name: '{{ item }}'
      loop: "{{ docker_engine_users | default([]) }}"

    - name: create http/https proxy config file for systemd service
      template:
        src: systemd_http_proxy.j2
        dest: "{{ docker_engine_systemd_proxy_config }}"
        owner: root
        group: root
        mode: 0644
      register: create_systemd_proxy_config_result
      notify:
        - restart docker
        - restart docker storage
      when:
        - ansible_facts.service_mgr == "systemd"
        - >-
          proxy_client_http_proxy | default('') | length > 0
          or proxy_client_https_proxy | default('') | length > 0
          or proxy_client_no_proxy | default('') | length > 0

    - name: reload systemd to apply new http/https config file
      command: systemctl daemon-reload
      when:
        - ansible_facts.service_mgr == "systemd"
        - create_systemd_proxy_config_result is changed

    - meta: flush_handlers
  tags:
    - role::docker_engine
    - role::docker_engine::configure
